# UC Davis CAES Next.js Starter

This is a starter template for building web applications using Next.js, created by CA&ES.

## Features

- **Next.js**: A React framework for building server-rendered applications.
- **TypeScript**: Strongly typed programming language that builds on JavaScript.
- **Dev Container**: Docker-based development environment for consistent setups.
- **Tailwind CSS**: Utility-first CSS framework for rapid UI development.
- **PostgreSQL**: Relational database management system.
- **Prisma**: Next-generation ORM for Node.js and TypeScript.
- **AuthJS (Next-Auth)**: Authentication solution for Next.js applications.
- **ESLint**: Tool for identifying and reporting on patterns in JavaScript.
- **Prettier**: Code formatter for maintaining consistent code style.
- **tRPC**: End-to-end typesafe APIs for Next.js applications.

## Working Notes

- DATABASE_URL will be autogenerated based on your folder name and loaded into the dev env. Can overwrite but only if you don't want to use local
- Still need to setup devcontainer plugins
- People should run `npx auth secret` to generate a secret for auth.js for new projects
- This is monorepo so everything after this assumes you are in the web directory

## Auth

This project uses [AuthJS](https://authjs.dev) for authentication. The configuration is located in `src/server/auth/config.ts`.

You can set up authentication providers such as Microsoft Entra ID and UC Davis CAS. Make sure to configure the environment variables in your `.env` file.

The login page `src/app/(public)/login/page.tsx` is used for the sign-in process. You can customize this page as needed or make it auto login if you want.

Any page under `src/app/(protected)` will require authentication to access.

Roles are up to you but if you want to add them to the session take a look at [the AuthJS documentation](https://authjs.dev/guides/role-based-access-control).

### Entra ID Setup

- create a new app registration in entra
- set the redirect URI to http://localhost:3000/api/auth/callback/microsoft-entra-id
- add some branding if desired and set publisher domain to ucdavis.edu
- create a client secret and save it
- clientID is the application (client) ID
- add the `AUTH_UCD_ENTRA*` env vars to your `.env.local` file
- the issuer is `https://login.microsoftonline.com/a8046f64-66c0-4f00-9046-c8daf92ff62b/v2.0` where that ID is our UCD Azure AD tenant ID

### CAS Setup

CAS is not working right now.

## Database & Querying

This project uses PostgreSQL as the database. The Prisma ORM is used for database interactions. tRPC is used for type-safe API calls.

You have a few options for making queries dpeneding on your needs:

### Server Queries

See `/` for an example of just a simple server-only query. This is useful for data that doesn't need to be reactive or updated on the client side. No API call is actually made over the wire, the query is executed directly on the server.

### Client Queries

See `/client` for examples of just doing regular client-side queries w/ react-query.

### Prefetching

See `/prefetch` for examples of prefetching data on the server and then using it in a client component. These are useful for data that you want to load on the server but then use in a client component without making another API call.

### Adding new API routes (aka controllers)

Routes are in `src/server/api/routes/`. You can create new files here to define your API endpoints.

Each route is given the db and user session as context.

### Route protection

Inside `src/server/trpc/trpc.ts` we've created `publicProcedure` and `protectedProcedure` to help with route protection. You can create your own procedures as needed, ex: `adminProcedure` or `editorProcedure`. Routes are created as a specific type of procedure and will thus run whatever checks you have defined for that procedure.

Alternately (or additionally), if you include the user roles in the auth session you can just check the session in your route handler.

==============================

Below is the standard Next.js README content, which is included in the project.

This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
